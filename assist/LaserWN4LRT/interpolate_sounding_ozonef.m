
% Transfer sounding into 60 levels for fast model
function [p,t,q,z,o3,ipsfc]=interpolate_sounding_ozonef(pmmo,tmmo,qmmo,o3mmo)
p_ref=[ 1000.,995.,990.,985.,980.,975.,970.,965.,960.,955.,950.,945.,...
            940.,935.,930.,925.,920.,915.,910.,905.,900.,880.,860.,840.,...
            820.,800.,780.,760.,740.,720.,700.,680.,660.,640.,620.,600.,...
            550.,500.,450.,400.,350.,300.,250.,200.,175.,150.,125.,100.,...
             75.,50.,  30., 25., 20., 15., 10.,  7.,  5.,  4.,  3.,  2.];

t_ref=[287.50, 287.23, 286.95, 286.68,...
      286.40, 286.12, 285.84, 285.56, 285.28, 285.00, 284.71, 284.43,...
      284.14, 283.85, 283.55, 283.26, 282.97, 282.67, 282.37, 282.07,...
      281.77, 280.58, 279.36, 278.12, 276.84, 275.53, 274.21, 272.87,...
      271.49, 270.07, 268.61, 267.15, 265.64, 264.08, 262.48, 260.85,...
      256.56, 251.95, 246.94, 241.45, 235.38, 228.58, 220.85, 216.72,...
      216.70, 216.70, 216.70, 216.70, 216.70, 217.28, 220.54, 221.72,...
      223.13, 225.00, 228.07, 232.64, 239.24, 243.65, 249.51, 257.93];

 w_ref=[4.701,  4.658,  4.614,  4.570,...
      4.525,  4.481,  4.436,  4.391,  4.346,  4.300,  4.254,  4.208,...
      4.162,  4.116,  4.070,  4.023,  3.975,  3.928,  3.880,  3.833,...
      3.785,  3.619,  3.451,  3.279,  3.104,  2.924,  2.741,  2.555,...
      2.364,  2.167,  1.969,  1.825,  1.678,  1.526,  1.368,  1.243,...
      0.931,  0.699,  0.499,  0.331,  0.211,  0.089,  0.035,  0.014,...
      0.009,  0.005,  0.003,  0.003,  0.0003,  0.0003,  0.0003,  0.0003,...
      0.0002,  0.0002,  0.0002,  0.0002,  0.0001,  0.0001,  0.0001,  0.0001];

  
 z_ref=[0,  0.049,  0.099,  0.1480,...
      0.198,  0.248,  0.298,  0.349,  0.399,  0.450,  0.501,  0.552,...
      0.604,  0.656,  0.708,  0.760,  0.812,  0.865,  0.918,  0.971,...
      1.024,  1.240,  1.460,  1.683,  1.912,  2.145,  2.382,  2.625,...
      2.873,  3.126,  3.385,  3.650,  3.922,  4.200,  4.485,  4.778,...
      5.547,  6.374,  7.272,  8.254,  9.341, 10.562, 11.961, 13.628,...
     14.616, 15.757, 17.106, 18.757, 20.885, 23.889, 27.708, 29.084,...
     30.779, 32.980, 36.116, 38.922, 41.632, 43.472, 45.894, 49.407];
  

% Interpolate Sounding to Normalized Pressure Scale
mlt=size(pmmo,2); nlt=mlt+1;
%pmm(1,nlt+1)=0;
psfc=pmmo(1,1);
pmmo(1,nlt+1)=0;
[C,ipsfc]=min(abs(psfc-p_ref));
if p_ref(1,ipsfc)<psfc && ipsfc>1; ipsfc=ipsfc-1; end;

% find number of levels
chk=0;
for i=1:nlt+1
    if chk==0 && pmmo(1,i)==0; nls=i-1; chk=10; end;
end;

% Add 1000mb level
if pmmo(1,1)<=1000;
pmmm(1,1)=1000; pmmm(1,2:nlt)=pmmo(1,1:mlt);
tmmm(1,1)=tmmo(1,1); tmmm(1,2:nlt)=tmmo(1,1:mlt);
qmmm(1,1)=qmmo(1,1); qmmm(1,2:nlt)=qmmo(1,1:mlt);
o3mmm(1,1)=o3mmo(1,1); o3mmm(1,2:nlt)=o3mmo(1,1:mlt);
else;
dpp(1,1:mlt)=pmmo(1,1)-1000;
pmmm(1,1)=1000; pmmm(1,2:nlt)=pmmo(1,1:mlt)-dpp(1,1:mlt);
tmmm(1,1)=tmmo(1,1); tmmm(1,2:nlt)=tmmo(1,1:mlt);
qmmm(1,1)=qmmo(1,1); qmmm(1,2:nlt)=qmmo(1,1:mlt);
o3mmm(1,1)=o3mmo(1,1); o3mmm(1,2:nlt)=o3mmo(1,1:mlt);
end;

% compute Height
    sumz=0;     
    %for j=1:nls-1;
    for j=1:nls;
        %if pmmm(1,j+1)~=0;
        sumz=sumz+(tmmm(1,j)+tmmm(1,j+1))*log(pmmm(1,j)/pmmm(1,j+1));
        zmmm(1,j+1)=sumz/(2*29.287);
        %else; zmmm(1,j+1)=0;
        %end;
    end;

yt=tmmm';
yq=qmmm';
yz=zmmm';
yo3=o3mmm';
x=pmmm';

clear pmmm2 tmmm2 zmmm2 qmmm2
for p=1:size(x,1)
    if p==1
        pp=1;
        pmmm2(pp,1)=x(1,1);
        tmmm2(pp,1)=yt(1,1);
        zmmm2(pp,1)=yz(1,1);
        qmmm2(pp,1)=yq(1,1);
        o3mmm2(pp,1)=yo3(1,1);
    else
        if x(p,1)<=pmmm2(pp,1)-1 %&& x(p,1)<=x(pp,1)+1;
            pp=pp+1;
            pmmm2(pp,1)=x(p,1);
            tmmm2(pp,1)=yt(p,1);
            zmmm2(pp,1)=yz(p,1);
            qmmm2(pp,1)=yq(p,1);
            o3mmm2(pp,1)=yo3(p,1);
        end
    end
end


% figure
% hold on
% plot(1:933,x,'b')
% plot(1:421,pmmm2,'r')

yt2=tmmm2;
yq2=qmmm2;
yo32=o3mmm2;
yz2=zmmm2;
x2=pmmm2;
xi2=p_ref; xi2(1,1)=x2(1,1);

t=interp1(x2,yt2,xi2,'linear',0);
q=interp1(x2,yq2,xi2,'linear',0);
z=interp1(x2,yz2,xi2,'linear',0);
o3=interp1(x2,yo32,xi2,'linear',0);
p=xi2;
for i=1:60;
    if t(1,i)==0; t(1,i)=t_ref(1,i); end;
    if q(1,i)==0; q(1,i)=w_ref(1,i); end;
    if z(1,i)==0; z(1,i)=z_ref(1,i); end;
    if o3(1,i)==0; o3(1,i)=o3(1,i-1); end;
end;




